# Image feature will come after normal features
# When changing feature list, also need to change 'categorial_feature' to
# specify which columns are categorical.
# IMPORTANT! Always put categorical features first in the feature list, as some
# features contains more than one columns, it will be hard to figure out
# categorical feature index if we mix them.

from hyperopt import hp

lightgbm_config_feature_list = [
  # Categorical features:
  'activation_weekday',
  'category_name',
  'city',
  'image_top_1',
  'param_1',
  'param_2',
  'param_3',
  'parent_category_name',
  'region',
  'user_type',
  'item_seq_number_bucket',
  "has_description",
  "has_image",
  "has_one_param",
  "has_price",
  "item_seq_number_is_one",
  'log_price',
  'price',
  'user_id-counts',
  'param_1-price-norm',
  'region+city+parent_category_name-counts',
  'region+category_name+param_1-price-norm',
  'item_seq_number',
  'user_id+param_1-price-mean',
  'region+param_1+activation_date-price-norm',
  'user_id+category_name-price-mean',
  'user_id+category_name-counts',
  'category_name-price-norm',
  'region+param_1-price-norm',
  'user_id+parent_category_name-counts',
  'desc_len_norm',
  'param_1+activation_date-price-norm',
  'region+city+param_1-price-norm',
  'user_id+region-counts',
  'parent_category_name-price-norm',
  'region+parent_category_name+param_1-price-norm',
  'region+city+param_1-counts',
  'user_id+parent_category_name-price-mean',
  'region+city+category_name-counts',
  'title_len_wc_ratio',
  'desc_uniq_wc',
  'title_len',
  'user_id+parent_category_name-price-std',
  'user_type-price-norm',
  'parent_category_name+param_1-price-norm',
  'category_name+param_1-price-norm',
  'user_id+param_1-price-std',
  'parent_category_name+param_1+activation_date-price-norm',
  'category_name+param_1+activation_date-price-norm',
  'desc_punc_count',
  'category_name+user_type-price-norm',
  'region+city+user_type-counts',
  'parent_category_name+activation_date-counts',
  'user_id-price-std',
  'region+parent_category_name-counts',
  'user_id+activation_date-counts',
  'user_id+activation_date-price-mean',
  'param_1-price-std',
  'user_id-price-norm',
  'region+city+category_name-price-norm',
  'desc_wc_norm',
  'user_id+param_1-counts',
  'region+param_1+user_type-price-norm',
  'region+category_name-price-norm',
  'user_id+category_name-price-std',
  'region+category_name+activation_date-price-norm',
  'region+city+activation_date-counts',
  # 'category_name-price-mean',
  'user_id-price-mean',
  'param_1+activation_date+user_type-price-norm',
  'region+city-counts',
  'category_name+activation_date-price-norm',
  'region+city+param_2-price-norm',
  'region+category_name-counts',
  'user_id+activation_date-price-std',
  'parent_category_name+user_type-price-norm',
  'parent_category_name+param_1+user_type-price-norm',
  'user_id+region-price-std',
  'region+city+param_3-price-norm',
  'desc_wc',
  'category_name-price-std',
  'category_name+param_1-price-std',
  'user_id+activation_date-price-norm',
  'region+city+parent_category_name-price-norm',
  'desc_upper_count_ratio',
  'region+category_name+user_type-price-norm',
  'region+parent_category_name-price-norm',
  'category_name+param_1+user_type-price-norm',
  'param_1-price-mean',
  'parent_category_name+param_1-price-std',
  'user_id+region-price-norm',
  'param_1+user_type-price-norm',
  'parent_category_name+activation_date+user_type-counts',
  'user_id+category_name-price-norm',
  'region+city+parent_category_name-price-mean',
  'category_name+param_1+user_type-price-std',
  'desc_letter_punc_ratio',
  'desc_uniq_wc_ratio',
  'region+param_1-counts',
  'region+city+param_2-counts',
  # 'parent_category_name-price-std',
  'user_id+param_2-price-mean',
  'region+city-price-norm',
  'user_id+region-price-mean',
  'category_name+activation_date+user_type-price-norm',
  'region+parent_category_name+activation_date-counts',
  'region+category_name-price-mean',
  'region+city+parent_category_name-price-std',
  'region+city+activation_date-price-norm',
  'region+category_name+param_1-price-mean',
  'desc_len_wc_norm_ratio',
  'desc_upper_count',
  'param_1-counts',
  'category_name+activation_date-counts',
  'param_1+user_type-counts',
  'region+activation_date+user_type-counts',
  'region+city-price-std',
  'region+parent_category_name+activation_date-price-norm',
  'region+parent_category_name+param_1-price-mean',
  'region+category_name+param_1-price-std',
  'desc_wc_norm_ratio',
  'title_wc',
  'region+parent_category_name+user_type-counts',
  'region+parent_category_name-price-std',
  'region+category_name-price-std',
  'category_name+activation_date-price-std',
  'parent_category_name+user_type-price-std',
  'region+param_2+activation_date-price-norm',
  'region+param_3+user_type-price-norm',
  # 'region+param_3+activation_date-price-norm',
  # 'desc_num_count',
  'title_num_count_ratio',
  'title_uniq_wc',
  'param_1+activation_date-price-std',
  'category_name+user_type-price-mean',
  'region+parent_category_name+param_1-price-std',
  'parent_category_name+param_1+user_type-price-std',
  'title_upper_count',
  # 'category_name-counts',
  'activation_date+user_type-counts',
  'category_name+user_type-counts',
  'param_2-price-norm',
  'region-price-norm',
  'user_id+parent_category_name-price-norm',
  'param_1+user_type-price-mean',
  'category_name+user_type-price-std',
  'region+city+user_type-price-mean',
  'region+city+user_type-price-norm',
  'region+city+param_1-price-mean',
  'region+city+param_2-price-std',
  'parent_category_name+param_1+activation_date-price-std',
  'region+city+category_name-price-std',
  'region+parent_category_name+param_1-counts',
  'region+parent_category_name-price-mean',
  'category_name+param_1-price-mean',
  # 'param_2+user_type-price-norm',
  'region+activation_date-price-std',
  # 'region+city+param_2-price-mean',
  'desc_wc_punc_ratio',
  'param_2-price-std',
  'user_id+param_1-price-norm',
  'parent_category_name+param_1-price-mean',
  'region+category_name+param_2-price-norm',
  'region+parent_category_name+user_type-price-mean',
  'region+parent_category_name+user_type-price-std',
  'category_name+param_1+activation_date-price-mean',
  'embedding',
  'avg_days_up_user',
  'avg_times_up_user',
  'n_user_items',
  # 'income2018',
  # 'growth_rate',
  "activation_date+user_type-price-diff",
    "activation_date-price-diff",
    "category_name+activation_date+user_type-price-diff",
    "category_name+activation_date-price-diff",
    "category_name+param_1+activation_date-price-diff",
    "category_name+param_1+user_type-price-diff",
    "category_name+param_1-price-diff",
    # "category_name+param_2+activation_date-price-diff",
    # "category_name+param_2+user_type-price-diff",
    "category_name+param_2-price-diff",
    # "category_name+param_3+activation_date-price-diff",
    # "category_name+param_3+user_type-price-diff",
    # "category_name+param_3-price-diff",
    "category_name+user_type-price-diff",
    "category_name-price-diff",
    "param_1+activation_date+user_type-price-diff",
    "param_1+activation_date-price-diff",
    "param_1+user_type-price-diff",
    "param_1-price-diff",
    # "param_2+activation_date+user_type-price-diff",
    # "param_2+activation_date-price-diff",
    "param_2+user_type-price-diff",
    # "param_2-price-diff",
    # "param_3+activation_date+user_type-price-diff",
    # "param_3+activation_date-price-diff",
    # "param_3+user_type-price-diff",
    # "param_3-price-diff",
    "parent_category_name+activation_date+user_type-price-diff",
    "parent_category_name+activation_date-price-diff",
    "parent_category_name+param_1+activation_date-price-diff",
    "parent_category_name+param_1+user_type-price-diff",
    "parent_category_name+param_1-price-diff",
    # "parent_category_name+param_2+activation_date-price-diff",
    # "parent_category_name+param_2+user_type-price-diff",
    # "parent_category_name+param_2-price-diff",
    # "parent_category_name+param_3+activation_date-price-diff",
    # "parent_category_name+param_3+user_type-price-diff",
    # "parent_category_name+param_3-price-diff",
    "parent_category_name+user_type-price-diff",
    "parent_category_name-price-diff",
    "region+activation_date+user_type-price-diff",
    "region+activation_date-price-diff",
    "region+category_name+activation_date-price-diff",
    "region+category_name+param_1-price-diff",
    # "region+category_name+param_2-price-diff",
    # "region+category_name+param_3-price-diff",
    "region+category_name+user_type-price-diff",
    "region+category_name-price-diff",
    "region+city+activation_date-price-diff",
    "region+city+category_name-price-diff",
    "region+city+param_1-price-diff",
    # "region+city+param_2-price-diff",
    # "region+city+param_3-price-diff",
    "region+city+parent_category_name-price-diff",
    "region+city+user_type-price-diff",
    "region+city-price-diff",
    "region+param_1+activation_date-price-diff",
    "region+param_1+user_type-price-diff",
    # "region+param_1-price-diff",
    # "region+param_2+activation_date-price-diff",
    # "region+param_2+user_type-price-diff",
    # "region+param_2-price-diff",
    # "region+param_3+activation_date-price-diff",
    # "region+param_3+user_type-price-diff",
    # "region+param_3-price-diff",
    "region+parent_category_name+activation_date-price-diff",
    # "region+parent_category_name+param_1-price-diff",
    # "region+parent_category_name+param_2-price-diff",
    # "region+parent_category_name+param_3-price-diff",
    # "region+parent_category_name+user_type-price-diff",
    "region+parent_category_name-price-diff",
    # "region+user_type-price-diff",
    # "region-price-diff",
    # "user_id+activation_date-price-diff",
    # "user_id+category_name-price-diff",
    # "user_id+param_1-price-diff",
    # "user_id+param_2-price-diff",
    # "user_id+param_3-price-diff",
    # "user_id+parent_category_name-price-diff",
    # "user_id+region-price-diff",
    # "user_id-price-diff",
    "user_type-price-diff"
]

lightgbm_config = {

        'features': lightgbm_config_feature_list,
        'folds': 3,
        'image_feature_folders': ['image_features/ads_image_features'],
        'model': 'lightgbm',
        # 'model_params': {
        #     'bagging_fraction': 0.898898411669864,
        #     'bagging_freq': 10,
        #     'boosting_type': 'gbdt',
        #     'categorical_feature': '0,1,2,3,4,5,6,7,8,9,10',
        #     'learning_rate': 0.15124909294038838,
        #     'max_bin': 255,
        #     'max_depth': 20,
        #     'metric': 'rmse',
        #     'min_data': 500,
        #     'min_data_in_bin': 300,
        #     'min_hessian': 0.40763623871852805,
        #     'num_leaves': 300,
        #     'num_boost_round': 1000,
        #     'objective': 'regression',
        #     'sub_feature': 0.2295600655921562,
        #     # 'top_k': 50,
        #     'top_k': 50,
        #     'seed': 42,
        #     'verbose': -1
        # },
        'categorical_feature': [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
        # 'model_params': {
        #   'boosting_type': 'gbdt',
        #   'learning_rate': 0.7464844287475868,
        #   'max_bin': 350,
        #   ''model_params': {'boosting_type': 'gbdt',
    # 'early_stopping_rounds': 35,
    # 'learning_rate': 0.14054984031531317,
    # 'max_bin': 350,
    # 'max_depth': 15,
    # 'metric': 'rmse',
    # 'min_data': 1500,
    # 'min_data_in_bin': 1000,
    # 'num_boost_round': 1000,
    # 'num_leaves': 64,
    # 'objective': 'regression',
    # 'sub_feature': 0.16408176343506528,
    # 'top_k': 50,
    # 'verbose': -1},
    'model_params': {'boosting_type': 'gbdt',
    'learning_rate': 0.14054984031531317,
    'early_stopping_rounds': 35,
    'max_bin': 350,
    'max_depth': 15,
    'metric': 'rmse',
    'min_data': 1500,
    'min_data_in_bin': 1000,
    'num_boost_round': 1500,
    'num_leaves': 64,
    'objective': 'regression',
    'sub_feature': 0.16408176343506528,
    'top_k': 50,
    'verbose': -1},
        # 'model_params': {'boosting_type': 'gbdt', 'learning_rate': 0.1518452576617124, 'max_bin': 500, 'max_depth': 7, 'metric': 'rmse', 'min_data': 750, 'min_data_in_bin': 100, 'min_hessian': 1.8088535712382525, 'num_boost_round': 446, 'num_leaves': 60, 'objective': 'regression', 'sub_feature': 0.22924361218798947, 'top_k': 50, 'verbose': -1},
    #   'model_params': {'boosting_type': 'gbdt',
    # 'learning_rate': 0.13559835916026047,
    # 'max_bin': 500,
    # 'max_depth': 7,
    # 'metric': 'rmse',
    # 'min_data': 750,
    # 'min_data_in_bin': 100,
    # 'min_hessian': 0.4965995198348241,
    # 'num_leaves': 30,
    # 'num_boost_round': 750,
    # 'objective': 'regression',
    # 'sub_feature': 0.18511250210880564,
    # 'top_k': 50,
    # 'verbose': -1},
    # 'model_params': {'boosting_type': 'gbdt',
    # 'learning_rate': 0.15996094906176148,
    # 'max_bin': 500,
    # 'max_depth': 10,
    # 'metric': 'rmse',
    # 'min_data': 2500,
    # 'min_data_in_bin': 1000,
    # 'num_boost_round': 524,
    # 'num_leaves': 150,
    # 'objective': 'regression',
    # 'sub_feature': 0.15869503448075753,
    # 'top_k': 50,
    # 'verbose': -1},
    # 'model_params': {'boosting_type': 'gbdt',
    # 'learning_rate': 0.13612406979489686,
    # 'max_bin': 500,
    # 'max_depth': 17,
    # 'metric': 'rmse',
    # 'min_data': 1000,
    # 'min_data_in_bin': 1000,
    # 'num_boost_round': 449,
    # 'num_leaves': 250,
    # 'objective': 'regression',
    # 'sub_feature': 0.1381067061003422,
    # 'top_k': 50,
    # 'verbose': -1},
    # 'features': lightgbm_config_feature_list,
    # 'image_feature_folders': ['image_features/ads_image_features'],
    # 'folds':2,
    # 'model': 'lightgbm',
    # 'model_params': {
    #     'categorical_feature': '0,1,2,3,4,5,6,7,8,9,10',
    #     'objective' : 'regression',
    #     'metric' : 'rmse',
    #     'num_leaves' : 32,
    #     'max_depth': 15,
    #     'learning_rate' ,
    #     'feature_fraction' ,
    #     'num_boost_round': 5000,
    #     # 'early_stopping_round': 500,
    #     'verbosity' : -1
    # },
    'tune_params': {
        'param_space': {
            'features': lightgbm_config_feature_list,
            'image_feature_folders': ['image_features/ads_image_features'],
            'model': 'lightgbm',
            'folds': 3,
            'categorical_feature': [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
            'model_params': {
                'max_depth': hp.choice('max_depth', [7, 10, 15]),
                # 'min_hessian': hp.loguniform('min_hessian', -1, 1),
                # 'bagging_fraction': hp.uniform('bagging_fraction', 0.3, 0.9),
                # 'bagging_freq': hp.choice('bagging_freq', [0, 10, 50, 100]),
                'sub_feature': hp.loguniform('sub_feature', -2, -1),
                # 'sub_feature': hp.uniform('sub_feature', 0.05, 0.3),
                'top_k':  hp.choice('top_k', [25, 50, 75]),
                'max_bin': hp.choice('max_bin', [255, 350, 500]),
                'min_data_in_bin': hp.choice('min_data_in_bin', [500, 1000, 1500]),

                'learning_rate': hp.loguniform('learning_rate', -2, -1),
                'boosting_type': 'gbdt',
                'objective': 'regression',
                # 'metric': hp.choice('metric', ['mae', 'mse']),
                'metric': 'rmse',
                'num_leaves': hp.choice('num_leaves', [64, 150, 250]),
                'min_data': hp.choice('min_data', [1000, 1500, 2500]),
                'num_boost_round': 1000,
                'early_stopping_rounds': 35,
                'verbose': -1
            },
        },
        'max_evals': 5
    }
}
